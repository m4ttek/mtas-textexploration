<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MtasSolrSearchComponent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MTAS</a> &gt; <a href="index.source.html" class="el_package">mtas.solr.handler.component</a> &gt; <span class="el_source">MtasSolrSearchComponent.java</span></div><h1>MtasSolrSearchComponent.java</h1><pre class="source lang-java linenums">package mtas.solr.handler.component;

import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.Map;
import java.util.Objects;
import java.util.Map.Entry;

import mtas.codec.util.CodecComponent.ComponentDocument;
import mtas.codec.util.CodecComponent.ComponentFacet;
import mtas.codec.util.CodecComponent.ComponentFields;
import mtas.codec.util.CodecComponent.ComponentGroup;
import mtas.codec.util.CodecComponent.ComponentHeatmap;
import mtas.codec.util.CodecComponent.ComponentCollection;
import mtas.codec.util.CodecComponent.ComponentKwic;
import mtas.codec.util.CodecComponent.ComponentList;
import mtas.codec.util.CodecComponent.ComponentPage;
import mtas.codec.util.CodecComponent.ComponentPosition;
import mtas.codec.util.CodecComponent.ComponentSpan;
import mtas.codec.util.CodecComponent.ComponentTermVector;
import mtas.codec.util.CodecComponent.ComponentToken;
import mtas.codec.util.CodecUtil;
import mtas.codec.util.Status;
import mtas.solr.handler.component.util.MtasSolrResultMerge;
import mtas.solr.handler.util.MtasSolrStatus;
import mtas.solr.handler.util.MtasSolrStatus.ShardStatus;
import mtas.solr.search.MtasSolrCollectionCache;
import mtas.solr.handler.component.util.MtasSolrComponentDocument;
import mtas.solr.handler.component.util.MtasSolrComponentFacet;
import mtas.solr.handler.component.util.MtasSolrComponentGroup;
import mtas.solr.handler.component.util.MtasSolrComponentHeatmap;
import mtas.solr.handler.MtasRequestHandler;
import mtas.solr.handler.MtasRequestHandler.ShardInformation;
import mtas.solr.handler.component.util.MtasSolrComponentCollection;
import mtas.solr.handler.component.util.MtasSolrComponentKwic;
import mtas.solr.handler.component.util.MtasSolrComponentList;
import mtas.solr.handler.component.util.MtasSolrComponentPage;
import mtas.solr.handler.component.util.MtasSolrComponentPrefix;
import mtas.solr.handler.component.util.MtasSolrComponentStats;
import mtas.solr.handler.component.util.MtasSolrComponentStatus;
import mtas.solr.handler.component.util.MtasSolrComponentTermvector;
import mtas.solr.handler.component.util.MtasSolrComponentVersion;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.lucene.index.ExitableDirectoryReader;
import org.apache.solr.common.params.CommonParams;
import org.apache.solr.common.params.ShardParams;
import org.apache.solr.common.util.NamedList;
import org.apache.solr.common.util.SimpleOrderedMap;
import org.apache.solr.core.SolrInfoBean;
import org.apache.solr.handler.component.ResponseBuilder;
import org.apache.solr.handler.component.SearchComponent;
import org.apache.solr.handler.component.ShardRequest;
import org.apache.solr.search.DocList;
import org.apache.solr.search.DocSet;
import org.apache.solr.search.SolrIndexSearcher;

/**
 * The Class MtasSolrSearchComponent.
 */
<span class="fc" id="L65">public class MtasSolrSearchComponent extends SearchComponent {</span>

	/** The log. */
<span class="fc" id="L68">	private static Log log = LogFactory.getLog(MtasSolrSearchComponent.class);</span>

	/** The search component. */
	MtasSolrSearchComponent searchComponent;

	/** The Constant CONFIG_COLLECTION_CACHE_DIRECTORY. */
	public static final String CONFIG_COLLECTION_CACHE_DIRECTORY = &quot;collectionCacheDirectory&quot;;

	/** The Constant CONFIG_COLLECTION_LIFETIME. */
	public static final String CONFIG_COLLECTION_LIFETIME = &quot;collectionLifetime&quot;;

	/** The Constant CONFIG_COLLECTION_MAXIMUM_NUMBER. */
	public static final String CONFIG_COLLECTION_MAXIMUM_NUMBER = &quot;collectionMaximumNumber&quot;;

	/** The Constant CONFIG_COLLECTION_MAXIMUM_OVERFLOW. */
	public static final String CONFIG_COLLECTION_MAXIMUM_OVERFLOW = &quot;collectionMaximumOverflow&quot;;

	/** The Constant NAME. */
	public static final String NAME = &quot;mtas&quot;;

	/** The Constant PARAM_MTAS. */
	public static final String PARAM_MTAS = &quot;mtas&quot;;

	/** The Constant STAGE_TERMVECTOR_MISSING_TOP. */
<span class="fc" id="L92">	public static final int STAGE_TERMVECTOR_MISSING_TOP = ResponseBuilder.STAGE_EXECUTE_QUERY + 10;</span>

	/** The Constant STAGE_TERMVECTOR_MISSING_KEY. */
<span class="fc" id="L95">	public static final int STAGE_TERMVECTOR_MISSING_KEY = ResponseBuilder.STAGE_EXECUTE_QUERY + 11;</span>

	/** The Constant STAGE_TERMVECTOR_FINISH. */
<span class="fc" id="L98">	public static final int STAGE_TERMVECTOR_FINISH = ResponseBuilder.STAGE_EXECUTE_QUERY + 12;</span>

	/** The Constant STAGE_LIST. */
<span class="fc" id="L101">	public static final int STAGE_LIST = ResponseBuilder.STAGE_EXECUTE_QUERY + 20;</span>

	/** The Constant STAGE_PREFIX. */
<span class="fc" id="L104">	public static final int STAGE_PREFIX = ResponseBuilder.STAGE_EXECUTE_QUERY + 30;</span>

	/** The Constant STAGE_STATS. */
<span class="fc" id="L107">	public static final int STAGE_STATS = ResponseBuilder.STAGE_EXECUTE_QUERY + 40;</span>

	/** The Constant STAGE_FACET. */
<span class="fc" id="L110">	public static final int STAGE_FACET = ResponseBuilder.STAGE_EXECUTE_QUERY + 50;</span>

	/** The Constant STAGE_HEATMAP. */
<span class="fc" id="L113">  public static final int STAGE_HEATMAP = ResponseBuilder.STAGE_EXECUTE_QUERY + 60;</span>

  /** The Constant STAGE_GROUP. */
<span class="fc" id="L116">	public static final int STAGE_GROUP = ResponseBuilder.STAGE_EXECUTE_QUERY + 70;</span>

	/** The Constant STAGE_COLLECTION_INIT. */
<span class="fc" id="L119">	public static final int STAGE_COLLECTION_INIT = ResponseBuilder.STAGE_EXECUTE_QUERY + 80;</span>

	/** The Constant STAGE_COLLECTION_FINISH. */
<span class="fc" id="L122">	public static final int STAGE_COLLECTION_FINISH = ResponseBuilder.STAGE_EXECUTE_QUERY + 81;</span>

	/** The Constant STAGE_DOCUMENT. */
<span class="fc" id="L125">	public static final int STAGE_DOCUMENT = ResponseBuilder.STAGE_GET_FIELDS + 10;</span>

	/** The mtas solr result merge. */
	private MtasSolrResultMerge mtasSolrResultMerge;

	/** The search stats. */
	private MtasSolrComponentStats searchStats;

	/** The search termvector. */
	private MtasSolrComponentTermvector searchTermvector;

	/** The search prefix. */
	private MtasSolrComponentPrefix searchPrefix;

	/** The search facet. */
	private MtasSolrComponentFacet searchFacet;

	/** The search group. */
	private MtasSolrComponentGroup searchGroup;

	/** The search list. */
	private MtasSolrComponentList searchList;

	/** The search kwic. */
	private MtasSolrComponentKwic searchKwic;

	/** The search page. */
  private MtasSolrComponentPage searchPage;

  /** The search heatmap. */
  private MtasSolrComponentHeatmap searchHeatmap;

  /** The search document. */
	private MtasSolrComponentDocument searchDocument;

	/** The search collection. */
	private MtasSolrComponentCollection searchCollection;

	/** The search status. */
	private MtasSolrComponentStatus searchStatus;

	/** The search version. */
	private MtasSolrComponentVersion searchVersion;

	/** The collection cache. */
<span class="fc" id="L170">	private MtasSolrCollectionCache collectionCache = null;</span>

	/** The request handler. */
<span class="fc" id="L173">	private MtasRequestHandler requestHandler = null;</span>

	/** The request handler name. */
<span class="fc" id="L176">	private String requestHandlerName = null;</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see org.apache.solr.handler.component.SearchComponent#init(org.apache.solr.
	 * common.util.NamedList)
	 */
	@Override
	public void init(NamedList args) {
<span class="fc" id="L186">		super.init(args);</span>
		// init components
<span class="fc" id="L188">		searchStatus = new MtasSolrComponentStatus(this);</span>
<span class="fc" id="L189">		searchVersion = new MtasSolrComponentVersion(this);</span>
<span class="fc" id="L190">		searchDocument = new MtasSolrComponentDocument(this);</span>
<span class="fc" id="L191">		searchKwic = new MtasSolrComponentKwic(this);</span>
<span class="fc" id="L192">		searchList = new MtasSolrComponentList(this);</span>
<span class="fc" id="L193">		searchPage = new MtasSolrComponentPage(this);</span>
<span class="fc" id="L194">		searchHeatmap = new MtasSolrComponentHeatmap(this);</span>
<span class="fc" id="L195">    searchGroup = new MtasSolrComponentGroup(this);</span>
<span class="fc" id="L196">		searchTermvector = new MtasSolrComponentTermvector(this);</span>
<span class="fc" id="L197">		searchPrefix = new MtasSolrComponentPrefix(this);</span>
<span class="fc" id="L198">		searchStats = new MtasSolrComponentStats(this);</span>
<span class="fc" id="L199">		searchFacet = new MtasSolrComponentFacet(this);</span>
<span class="fc" id="L200">		searchCollection = new MtasSolrComponentCollection(this);</span>
		// init collection
<span class="fc" id="L202">		String collectionCacheDirectory = null;</span>
<span class="fc" id="L203">		Long collectionLifetime = null;</span>
<span class="fc" id="L204">		Integer collectionMaximumNumber = null;</span>
<span class="fc" id="L205">		Integer collectionMaximumOverflow = null;</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">		if (args.get(CONFIG_COLLECTION_CACHE_DIRECTORY) != null</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">				&amp;&amp; args.get(CONFIG_COLLECTION_CACHE_DIRECTORY) instanceof String) {</span>
<span class="fc" id="L208">			collectionCacheDirectory = (String) args.get(CONFIG_COLLECTION_CACHE_DIRECTORY);</span>
		} else {
<span class="nc" id="L210">			log.error(&quot;no &quot; + CONFIG_COLLECTION_CACHE_DIRECTORY + &quot; defined for &quot; + this.getClass().getSimpleName());</span>
		}
<span class="pc bpc" id="L212" title="2 of 4 branches missed.">		if (args.get(CONFIG_COLLECTION_LIFETIME) != null &amp;&amp; args.get(CONFIG_COLLECTION_LIFETIME) instanceof Long) {</span>
<span class="fc" id="L213">			collectionLifetime = (Long) args.get(CONFIG_COLLECTION_LIFETIME);</span>
		} else {
<span class="nc" id="L215">			log.error(&quot;no &quot; + CONFIG_COLLECTION_LIFETIME + &quot; defined for &quot; + this.getClass().getSimpleName());</span>
		}
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">		if (args.get(CONFIG_COLLECTION_MAXIMUM_NUMBER) != null</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">				&amp;&amp; args.get(CONFIG_COLLECTION_MAXIMUM_NUMBER) instanceof Integer) {</span>
<span class="fc" id="L219">			collectionMaximumNumber = (Integer) args.get(CONFIG_COLLECTION_MAXIMUM_NUMBER);</span>
		} else {
<span class="nc" id="L221">			log.error(&quot;no &quot; + CONFIG_COLLECTION_MAXIMUM_NUMBER + &quot; defined for &quot; + this.getClass().getSimpleName());</span>
		}
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">		if (args.get(CONFIG_COLLECTION_MAXIMUM_OVERFLOW) != null</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">				&amp;&amp; args.get(CONFIG_COLLECTION_MAXIMUM_OVERFLOW) instanceof Integer) {</span>
<span class="fc" id="L225">			collectionMaximumNumber = (Integer) args.get(CONFIG_COLLECTION_MAXIMUM_OVERFLOW);</span>
		} else {
<span class="nc" id="L227">			log.error(&quot;no &quot; + CONFIG_COLLECTION_MAXIMUM_OVERFLOW + &quot; defined for &quot; + this.getClass().getSimpleName());</span>
		}
<span class="fc" id="L229">		collectionCache = new MtasSolrCollectionCache(collectionCacheDirectory, collectionLifetime,</span>
				collectionMaximumNumber, collectionMaximumOverflow);
<span class="fc" id="L231">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see org.apache.solr.handler.component.SearchComponent#getDescription()
	 */
	@Override
	public String getDescription() {
<span class="nc" id="L240">		return &quot;Mtas&quot;;</span>
	}

	/**
	 * Gets the collection cache.
	 *
	 * @return the collection cache
	 */
	public MtasSolrCollectionCache getCollectionCache() {
<span class="fc" id="L249">		return collectionCache;</span>
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * org.apache.solr.handler.component.SearchComponent#prepare(org.apache.solr.
	 * handler.component.ResponseBuilder)
	 */
	@Override
	public void prepare(ResponseBuilder rb) throws IOException {
		// System.out
		// .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
		// + &quot; - &quot; + rb.req.getParams().getBool(ShardParams.IS_SHARD, false)
		// + &quot; PREPARE &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
		// always create status
<span class="fc" id="L266">		initializeRequestHandler(rb);</span>
<span class="fc" id="L267">		MtasSolrStatus solrStatus = new MtasSolrStatus(rb.req.getOriginalParams().toQueryString(),</span>
<span class="fc" id="L268">				rb.req.getParams().getBool(ShardParams.IS_SHARD, false), rb.shards, rb.rsp);</span>
<span class="fc" id="L269">		rb.req.getContext().put(MtasSolrStatus.class, solrStatus);</span>
<span class="fc" id="L270">		solrStatus.setStage(rb.stage);</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">		if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>
			try {
				// initialize
<span class="fc" id="L274">				mtasSolrResultMerge = new MtasSolrResultMerge();</span>
				// prepare components
<span class="fc" id="L276">				ComponentFields mtasFields = new ComponentFields();</span>
				// get settings version
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentVersion.PARAM_MTAS_VERSION, false)) {</span>
<span class="nc" id="L279">					searchVersion.prepare(rb, mtasFields);</span>
				}
				// get settings status
<span class="fc bfc" id="L282" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentStatus.PARAM_MTAS_STATUS, false)) {</span>
<span class="fc" id="L283">					searchStatus.prepare(rb, mtasFields);</span>
<span class="fc" id="L284">					mtasFields.status.handler = requestHandlerName;</span>
<span class="fc bfc" id="L285" title="All 2 branches covered.">					if (mtasFields.status.key != null) {</span>
<span class="fc" id="L286">						solrStatus.setKey(mtasFields.status.key);</span>
					}
				}
				// now, register status
<span class="fc" id="L290">				registerStatus(solrStatus);</span>
				// get settings document
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentDocument.PARAM_MTAS_DOCUMENT, false)) {</span>
<span class="nc" id="L293">					searchDocument.prepare(rb, mtasFields);</span>
				}
				// get settings kwic
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentKwic.PARAM_MTAS_KWIC, false)) {</span>
<span class="nc" id="L297">					searchKwic.prepare(rb, mtasFields);</span>
				}
				// get settings list
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentList.PARAM_MTAS_LIST, false)) {</span>
<span class="nc" id="L301">					searchList.prepare(rb, mtasFields);</span>
				}
			  // get settings page
<span class="pc bpc" id="L304" title="1 of 2 branches missed.">        if (rb.req.getParams().getBool(MtasSolrComponentPage.PARAM_MTAS_PAGE, false)) {</span>
<span class="nc" id="L305">          searchPage.prepare(rb, mtasFields);</span>
        }
        // get settings page
<span class="fc bfc" id="L308" title="All 2 branches covered.">        if (rb.req.getParams().getBool(MtasSolrComponentHeatmap.PARAM_MTAS_HEATMAP, false)) {</span>
<span class="fc" id="L309">          searchHeatmap.prepare(rb, mtasFields);</span>
        }
        // get settings group
<span class="fc bfc" id="L312" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentGroup.PARAM_MTAS_GROUP, false)) {</span>
<span class="fc" id="L313">					searchGroup.prepare(rb, mtasFields);</span>
				}
				// get settings termvector
<span class="fc bfc" id="L316" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L317">					searchTermvector.prepare(rb, mtasFields);</span>
				}
				// get settings prefix
<span class="fc bfc" id="L320" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentPrefix.PARAM_MTAS_PREFIX, false)) {</span>
<span class="fc" id="L321">					searchPrefix.prepare(rb, mtasFields);</span>
				}
				// get settings stats
<span class="fc bfc" id="L324" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentStats.PARAM_MTAS_STATS, false)) {</span>
<span class="fc" id="L325">					searchStats.prepare(rb, mtasFields);</span>
				}
				// get settings facet
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentFacet.PARAM_MTAS_FACET, false)) {</span>
<span class="nc" id="L329">					searchFacet.prepare(rb, mtasFields);</span>
				}
				// get settings collection
<span class="fc bfc" id="L332" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L333">					searchCollection.prepare(rb, mtasFields);</span>
				}
<span class="fc" id="L335">				rb.req.getContext().put(ComponentFields.class, mtasFields);</span>
<span class="nc" id="L336">			} catch (ExitableDirectoryReader.ExitingReaderException e) {</span>
<span class="nc" id="L337">				solrStatus.setError(e.getMessage());</span>
<span class="nc" id="L338">			} catch (IOException e) {</span>
<span class="nc" id="L339">				solrStatus.setError(e);</span>
			} finally {
<span class="pc" id="L341">				checkStatus(solrStatus);</span>
<span class="pc" id="L342">			}</span>
		} else {
			// register and check status
<span class="fc" id="L345">			registerStatus(solrStatus);</span>
<span class="fc" id="L346">			checkStatus(solrStatus);</span>
		}
<span class="fc" id="L348">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * org.apache.solr.handler.component.SearchComponent#process(org.apache.solr.
	 * handler.component.ResponseBuilder)
	 */
	@Override
	public void process(ResponseBuilder rb) throws IOException {
		// System.out
		// .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
		// + &quot; - &quot; + rb.req.getParams().getBool(ShardParams.IS_SHARD, false)
		// + &quot; PROCESS &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc" id="L363">		MtasSolrStatus solrStatus = Objects</span>
<span class="fc" id="L364">				.requireNonNull((MtasSolrStatus) rb.req.getContext().get(MtasSolrStatus.class), &quot;couldn't find status&quot;);</span>
<span class="fc" id="L365">		solrStatus.setStage(rb.stage);</span>
		try {
<span class="fc bfc" id="L367" title="All 2 branches covered.">			if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>
				try {
<span class="fc" id="L369">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">					if (mtasFields != null) {</span>
<span class="fc" id="L371">						DocSet docSet = rb.getResults().docSet;</span>
<span class="fc" id="L372">						DocList docList = rb.getResults().docList;</span>
<span class="pc bpc" id="L373" title="8 of 26 branches missed.">						if (mtasFields.doStats || mtasFields.doDocument || mtasFields.doKwic || mtasFields.doList </span>
						    || mtasFields.doPage || mtasFields.doHeatmap
								|| mtasFields.doGroup || mtasFields.doFacet || mtasFields.doCollection
								|| mtasFields.doTermVector || mtasFields.doPrefix || mtasFields.doStatus
								|| mtasFields.doVersion) {
<span class="fc" id="L378">							SolrIndexSearcher searcher = rb.req.getSearcher();</span>
<span class="fc" id="L379">							ArrayList&lt;Integer&gt; docSetList = null;</span>
<span class="fc" id="L380">							ArrayList&lt;Integer&gt; docListList = null;</span>
							// initialise docSetList
<span class="fc bfc" id="L382" title="All 2 branches covered.">							if (docSet != null) {</span>
<span class="fc" id="L383">								docSetList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L384">								Iterator&lt;Integer&gt; docSetIterator = docSet.iterator();</span>
<span class="fc bfc" id="L385" title="All 2 branches covered.">								while (docSetIterator.hasNext()) {</span>
<span class="fc" id="L386">									docSetList.add(docSetIterator.next());</span>
								}
<span class="fc" id="L388">								Collections.sort(docSetList);</span>
							}
							// initialise docListList
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">							if (docList != null) {</span>
<span class="fc" id="L392">								docListList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L393">								Iterator&lt;Integer&gt; docListIterator = docList.iterator();</span>
<span class="fc bfc" id="L394" title="All 2 branches covered.">								while (docListIterator.hasNext()) {</span>
<span class="fc" id="L395">									docListList.add(docListIterator.next());</span>
								}
<span class="fc" id="L397">								Collections.sort(docListList);</span>
							}
<span class="fc" id="L399">							solrStatus.status().addSubs(mtasFields.list.keySet());</span>
<span class="fc bfc" id="L400" title="All 2 branches covered.">							for (String field : mtasFields.list.keySet()) {</span>
								try {
<span class="fc" id="L402">									CodecUtil.collectField(field, searcher, searcher.getRawReader(), docListList,</span>
<span class="fc" id="L403">											docSetList, mtasFields.list.get(field), solrStatus.status());</span>
<span class="nc" id="L404">								} catch (IllegalAccessException | IllegalArgumentException</span>
										| InvocationTargetException e) {
<span class="nc" id="L406">									log.error(e);</span>
<span class="nc" id="L407">									throw new IOException(e);</span>
<span class="fc" id="L408">								}</span>
<span class="fc" id="L409">							}</span>
<span class="fc bfc" id="L410" title="All 2 branches covered.">							for (ComponentCollection collection : mtasFields.collection) {</span>
<span class="fc" id="L411">								CodecUtil.collectCollection(searcher.getRawReader(), docSetList, collection);</span>
<span class="fc" id="L412">							}</span>
<span class="fc" id="L413">							NamedList&lt;Object&gt; mtasResponse = new SimpleOrderedMap&lt;&gt;();</span>
<span class="pc bpc" id="L414" title="1 of 2 branches missed.">							if (mtasFields.doVersion) {</span>
<span class="nc" id="L415">								SimpleOrderedMap&lt;Object&gt; versionResponse = searchVersion.create(mtasFields.version,</span>
<span class="nc" id="L416">										false);</span>
<span class="nc" id="L417">								mtasResponse.add(MtasSolrComponentVersion.NAME, versionResponse);</span>
							}
<span class="fc bfc" id="L419" title="All 2 branches covered.">							if (mtasFields.doStatus) {</span>
								// add to response
<span class="fc" id="L421">								SimpleOrderedMap&lt;Object&gt; statusResponse = searchStatus.create(mtasFields.status, false);</span>
<span class="fc bfc" id="L422" title="All 2 branches covered.">								if (statusResponse != null) {</span>
<span class="fc" id="L423">									mtasResponse.add(MtasSolrComponentStatus.NAME,</span>
<span class="fc" id="L424">											searchStatus.create(mtasFields.status, false));</span>
								}
							}
<span class="pc bpc" id="L427" title="1 of 2 branches missed.">							if (mtasFields.doDocument) {</span>
<span class="nc" id="L428">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasDocumentResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">									for (ComponentDocument document : mtasFields.list.get(field).documentList) {</span>
<span class="nc" id="L431">										mtasDocumentResponses.add(searchDocument.create(document, false));</span>
<span class="nc" id="L432">									}</span>
<span class="nc" id="L433">								}</span>
								// add to response
<span class="nc" id="L435">								mtasResponse.add(MtasSolrComponentDocument.NAME, mtasDocumentResponses);</span>
							}
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">							if (mtasFields.doKwic) {</span>
<span class="nc" id="L438">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasKwicResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">									for (ComponentKwic kwic : mtasFields.list.get(field).kwicList) {</span>
<span class="nc" id="L441">										mtasKwicResponses.add(searchKwic.create(kwic, false));</span>
<span class="nc" id="L442">									}</span>
<span class="nc" id="L443">								}</span>
								// add to response
<span class="nc" id="L445">								mtasResponse.add(MtasSolrComponentKwic.NAME, mtasKwicResponses);</span>
							}
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">							if (mtasFields.doFacet) {</span>
<span class="nc" id="L448">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasFacetResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">									for (ComponentFacet facet : mtasFields.list.get(field).facetList) {</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">										if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="nc" id="L452">											mtasFacetResponses.add(searchFacet.create(facet, true));</span>
										} else {
<span class="nc" id="L454">											mtasFacetResponses.add(searchFacet.create(facet, false));</span>
										}
<span class="nc" id="L456">									}</span>
<span class="nc" id="L457">								}</span>
								// add to response
<span class="nc" id="L459">								mtasResponse.add(MtasSolrComponentFacet.NAME, mtasFacetResponses);</span>
							}
<span class="fc bfc" id="L461" title="All 2 branches covered.">							if (mtasFields.doCollection) {</span>
<span class="fc" id="L462">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasCollectionResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L463" title="All 2 branches covered.">								for (ComponentCollection collection : mtasFields.collection) {</span>
<span class="fc bfc" id="L464" title="All 2 branches covered.">									if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L465">										mtasCollectionResponses.add(searchCollection.create(collection, true));</span>
									} else {
<span class="fc" id="L467">										mtasCollectionResponses.add(searchCollection.create(collection, false));</span>
									}
<span class="fc" id="L469">								}</span>
								// add to response
<span class="fc" id="L471">								mtasResponse.add(MtasSolrComponentCollection.NAME, mtasCollectionResponses);</span>
							}
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">							if (mtasFields.doList) {</span>
<span class="nc" id="L474">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasListResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">									for (ComponentList list : mtasFields.list.get(field).listList) {</span>
<span class="nc" id="L477">										mtasListResponses.add(searchList.create(list, false));</span>
<span class="nc" id="L478">									}</span>
<span class="nc" id="L479">								}</span>
								// add to response
<span class="nc" id="L481">								mtasResponse.add(MtasSolrComponentList.NAME, mtasListResponses);</span>
							}
<span class="pc bpc" id="L483" title="1 of 2 branches missed.">							if (mtasFields.doPage) {</span>
<span class="nc" id="L484">                ArrayList&lt;NamedList&lt;?&gt;&gt; mtasPageResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">                for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">                  for (ComponentPage page : mtasFields.list.get(field).pageList) {</span>
<span class="nc" id="L487">                    mtasPageResponses.add(searchPage.create(page, false));</span>
<span class="nc" id="L488">                  }</span>
<span class="nc" id="L489">                }</span>
                // add to response
<span class="nc" id="L491">                mtasResponse.add(MtasSolrComponentPage.NAME, mtasPageResponses);</span>
              }
<span class="fc bfc" id="L493" title="All 2 branches covered.">							if (mtasFields.doHeatmap) {</span>
<span class="fc" id="L494">                ArrayList&lt;NamedList&lt;?&gt;&gt; mtasHeatmapResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L495" title="All 2 branches covered.">                for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L496" title="All 2 branches covered.">                  for (ComponentHeatmap heatmap : mtasFields.list.get(field).heatmapList) {</span>
<span class="fc bfc" id="L497" title="All 2 branches covered.">                    if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L498">                      mtasHeatmapResponses.add(searchHeatmap.create(heatmap, true));</span>
                    } else {
<span class="fc" id="L500">                      mtasHeatmapResponses.add(searchHeatmap.create(heatmap, false));</span>
                    }  
<span class="fc" id="L502">                  }</span>
<span class="fc" id="L503">                }</span>
                // add to response
<span class="fc" id="L505">                mtasResponse.add(MtasSolrComponentHeatmap.NAME, mtasHeatmapResponses);</span>
              }
<span class="fc bfc" id="L507" title="All 2 branches covered.">              if (mtasFields.doGroup) {</span>
<span class="fc" id="L508">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasGroupResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L509" title="All 2 branches covered.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L510" title="All 2 branches covered.">									for (ComponentGroup group : mtasFields.list.get(field).groupList) {</span>
<span class="pc bpc" id="L511" title="1 of 2 branches missed.">										if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="nc" id="L512">											mtasGroupResponses.add(searchGroup.create(group, true));</span>
										} else {
<span class="fc" id="L514">											mtasGroupResponses.add(searchGroup.create(group, false));</span>
										}
<span class="fc" id="L516">									}</span>
<span class="fc" id="L517">								}</span>
								// add to response
<span class="fc" id="L519">								mtasResponse.add(MtasSolrComponentGroup.NAME, mtasGroupResponses);</span>
							}
<span class="fc bfc" id="L521" title="All 2 branches covered.">							if (mtasFields.doTermVector) {</span>
<span class="fc" id="L522">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasTermVectorResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L523" title="All 2 branches covered.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L524" title="All 2 branches covered.">									for (ComponentTermVector termVector : mtasFields.list.get(field).termVectorList) {</span>
<span class="fc bfc" id="L525" title="All 2 branches covered.">										if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L526">											mtasTermVectorResponses.add(searchTermvector.create(termVector, true));</span>
										} else {
<span class="fc" id="L528">											mtasTermVectorResponses.add(searchTermvector.create(termVector, false));</span>
										}
<span class="fc" id="L530">									}</span>
<span class="fc" id="L531">								}</span>
								// add to response
<span class="fc" id="L533">								mtasResponse.add(MtasSolrComponentTermvector.NAME, mtasTermVectorResponses);</span>
							}
<span class="fc bfc" id="L535" title="All 2 branches covered.">							if (mtasFields.doPrefix) {</span>
<span class="fc" id="L536">								ArrayList&lt;NamedList&lt;?&gt;&gt; mtasPrefixResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L537" title="All 2 branches covered.">								for (String field : mtasFields.list.keySet()) {</span>
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">									if (mtasFields.list.get(field).prefix != null) {</span>
<span class="fc bfc" id="L539" title="All 2 branches covered.">										if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L540">											mtasPrefixResponses</span>
<span class="fc" id="L541">													.add(searchPrefix.create(mtasFields.list.get(field).prefix, true));</span>
										} else {
<span class="fc" id="L543">											mtasPrefixResponses</span>
<span class="fc" id="L544">													.add(searchPrefix.create(mtasFields.list.get(field).prefix, false));</span>
										}
									}
<span class="fc" id="L547">								}</span>
<span class="fc" id="L548">								mtasResponse.add(MtasSolrComponentPrefix.NAME, mtasPrefixResponses);</span>
							}
<span class="fc bfc" id="L550" title="All 2 branches covered.">							if (mtasFields.doStats) {</span>
<span class="fc" id="L551">								NamedList&lt;Object&gt; mtasStatsResponse = new SimpleOrderedMap&lt;&gt;();</span>
<span class="pc bpc" id="L552" title="1 of 6 branches missed.">								if (mtasFields.doStatsPositions || mtasFields.doStatsTokens</span>
										|| mtasFields.doStatsSpans) {
<span class="fc bfc" id="L554" title="All 2 branches covered.">									if (mtasFields.doStatsTokens) {</span>
<span class="fc" id="L555">										ArrayList&lt;Object&gt; mtasStatsTokensResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L556" title="All 2 branches covered.">										for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L557" title="All 2 branches covered.">											for (ComponentToken token : mtasFields.list.get(field).statsTokenList) {</span>
<span class="fc bfc" id="L558" title="All 2 branches covered.">												if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L559">													mtasStatsTokensResponses.add(searchStats.create(token, true));</span>
												} else {
<span class="fc" id="L561">													mtasStatsTokensResponses.add(searchStats.create(token, false));</span>
												}
<span class="fc" id="L563">											}</span>
<span class="fc" id="L564">										}</span>
<span class="fc" id="L565">										mtasStatsResponse.add(MtasSolrComponentStats.NAME_TOKENS,</span>
												mtasStatsTokensResponses);
									}
<span class="fc bfc" id="L568" title="All 2 branches covered.">									if (mtasFields.doStatsPositions) {</span>
<span class="fc" id="L569">										ArrayList&lt;Object&gt; mtasStatsPositionsResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L570" title="All 2 branches covered.">										for (String field : mtasFields.list.keySet()) {</span>
											for (ComponentPosition position : mtasFields.list
<span class="fc bfc" id="L572" title="All 2 branches covered.">													.get(field).statsPositionList) {</span>
<span class="fc bfc" id="L573" title="All 2 branches covered.">												if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L574">													mtasStatsPositionsResponses.add(searchStats.create(position, true));</span>
												} else {
<span class="fc" id="L576">													mtasStatsPositionsResponses</span>
<span class="fc" id="L577">															.add(searchStats.create(position, false));</span>
												}
<span class="fc" id="L579">											}</span>
<span class="fc" id="L580">										}</span>
<span class="fc" id="L581">										mtasStatsResponse.add(MtasSolrComponentStats.NAME_POSITIONS,</span>
												mtasStatsPositionsResponses);
									}
<span class="fc bfc" id="L584" title="All 2 branches covered.">									if (mtasFields.doStatsSpans) {</span>
<span class="fc" id="L585">										ArrayList&lt;Object&gt; mtasStatsSpansResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L586" title="All 2 branches covered.">										for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L587" title="All 2 branches covered.">											for (ComponentSpan span : mtasFields.list.get(field).statsSpanList) {</span>
<span class="fc bfc" id="L588" title="All 2 branches covered.">												if (rb.req.getParams().getBool(ShardParams.IS_SHARD, false)) {</span>
<span class="fc" id="L589">													mtasStatsSpansResponses.add(searchStats.create(span, true));</span>
												} else {
<span class="fc" id="L591">													mtasStatsSpansResponses.add(searchStats.create(span, false));</span>
												}
<span class="fc" id="L593">											}</span>
<span class="fc" id="L594">										}</span>
<span class="fc" id="L595">										mtasStatsResponse.add(MtasSolrComponentStats.NAME_SPANS,</span>
												mtasStatsSpansResponses);
									}
									// add to response
<span class="fc" id="L599">									mtasResponse.add(MtasSolrComponentStats.NAME, mtasStatsResponse);</span>
								}
							}
							// add to response
<span class="fc bfc" id="L603" title="All 2 branches covered.">							if (mtasResponse.size() &gt; 0) {</span>
<span class="fc" id="L604">								rb.rsp.add(NAME, mtasResponse);</span>
							}
						}
					}
<span class="nc" id="L608">				} catch (IOException e) {</span>
<span class="nc" id="L609">					errorStatus(solrStatus, e);</span>
<span class="fc" id="L610">				}</span>
			}
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">			if (!solrStatus.error()) {</span>
				// always set status segments
<span class="fc bfc" id="L614" title="All 2 branches covered.">				if (solrStatus.status().numberSegmentsTotal == null) {</span>
<span class="fc" id="L615">					solrStatus.status().numberSegmentsTotal = rb.req.getSearcher().getRawReader().leaves().size();</span>
<span class="fc" id="L616">					solrStatus.status().numberSegmentsFinished = solrStatus.status().numberSegmentsTotal;</span>
				}
				// always try to set number of documents
<span class="fc bfc" id="L619" title="All 2 branches covered.">				if (solrStatus.status().numberDocumentsTotal == null) {</span>
					SolrIndexSearcher searcher;
<span class="pc bpc" id="L621" title="1 of 2 branches missed.">					if ((searcher = rb.req.getSearcher()) != null) {</span>
<span class="fc" id="L622">						solrStatus.status().numberDocumentsTotal = (long) searcher.numDocs();</span>
<span class="pc bpc" id="L623" title="1 of 2 branches missed.">						if (rb.getResults().docList != null) {</span>
<span class="fc" id="L624">							solrStatus.status().numberDocumentsFinished = rb.getResults().docList.matches();</span>
<span class="fc" id="L625">							solrStatus.status().numberDocumentsFound = rb.getResults().docList.matches();</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">						} else if (rb.getResults().docSet != null) {</span>
<span class="nc" id="L627">							solrStatus.status().numberDocumentsFinished = (long) rb.getResults().docSet.size();</span>
<span class="nc" id="L628">							solrStatus.status().numberDocumentsFound = (long) rb.getResults().docSet.size();</span>
						}
					}
				}
			}
<span class="nc" id="L633">		} catch (ExitableDirectoryReader.ExitingReaderException e) {</span>
<span class="nc" id="L634">			solrStatus.setError(e.getMessage());</span>
		} finally {
<span class="pc" id="L636">			checkStatus(solrStatus);</span>
<span class="pc" id="L637">			finishStatus(solrStatus);</span>
<span class="pc" id="L638">		}</span>
<span class="fc" id="L639">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * org.apache.solr.handler.component.SearchComponent#modifyRequest(org.apache.
	 * solr.handler.component.ResponseBuilder,
	 * org.apache.solr.handler.component.SearchComponent,
	 * org.apache.solr.handler.component.ShardRequest)
	 */
	@Override
	public void modifyRequest(ResponseBuilder rb, SearchComponent who, ShardRequest sreq) {
		 // System.out
		 // .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
		 // + &quot; - &quot; + rb.req.getParams().getBool(ShardParams.IS_SHARD, false)
		 // + &quot; MODIFY REQUEST &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc" id="L656">		MtasSolrStatus solrStatus = Objects</span>
<span class="fc" id="L657">				.requireNonNull((MtasSolrStatus) rb.req.getContext().get(MtasSolrStatus.class), &quot;couldn't find status&quot;);</span>
<span class="fc" id="L658">		solrStatus.setStage(rb.stage);</span>
		try {
<span class="fc bfc" id="L660" title="All 2 branches covered.">			if (sreq.params.getBool(PARAM_MTAS, false)) {</span>
<span class="pc bpc" id="L661" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentStatus.PARAM_MTAS_STATUS, false)) {</span>
<span class="nc" id="L662">					searchStatus.modifyRequest(rb, who, sreq);</span>
<span class="pc bpc" id="L663" title="1 of 2 branches missed.">				} else if (requestHandler != null) {</span>
<span class="fc" id="L664">					sreq.params.add(MtasSolrComponentStatus.PARAM_MTAS_STATUS, CommonParams.TRUE);</span>
				}
<span class="pc bpc" id="L666" title="1 of 2 branches missed.">				if (requestHandler != null) {</span>
<span class="fc" id="L667">					sreq.params.add(MtasSolrComponentStatus.PARAM_MTAS_STATUS + &quot;.&quot;</span>
<span class="fc" id="L668">							+ MtasSolrComponentStatus.NAME_MTAS_STATUS_KEY, solrStatus.shardKey(rb.stage));</span>
				}
<span class="pc bpc" id="L670" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentVersion.PARAM_MTAS_VERSION, false)) {</span>
<span class="nc" id="L671">					searchVersion.modifyRequest(rb, who, sreq);</span>
				}
<span class="fc bfc" id="L673" title="All 2 branches covered.">				if (sreq.params.getBool(MtasSolrComponentStats.PARAM_MTAS_STATS, false)) {</span>
<span class="fc" id="L674">					searchStats.modifyRequest(rb, who, sreq);</span>
				}
<span class="fc bfc" id="L676" title="All 2 branches covered.">				if (sreq.params.getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L677">					searchTermvector.modifyRequest(rb, who, sreq);</span>
				}
<span class="fc bfc" id="L679" title="All 2 branches covered.">				if (sreq.params.getBool(MtasSolrComponentPrefix.PARAM_MTAS_PREFIX, false)) {</span>
<span class="fc" id="L680">					searchPrefix.modifyRequest(rb, who, sreq);</span>
				}
<span class="pc bpc" id="L682" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentFacet.PARAM_MTAS_FACET, false)) {</span>
<span class="nc" id="L683">					searchFacet.modifyRequest(rb, who, sreq);</span>
				}
<span class="fc bfc" id="L685" title="All 2 branches covered.">				if (sreq.params.getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L686">					searchCollection.modifyRequest(rb, who, sreq);</span>
				}
<span class="pc bpc" id="L688" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentGroup.PARAM_MTAS_GROUP, false)) {</span>
<span class="nc" id="L689">					searchGroup.modifyRequest(rb, who, sreq);</span>
				}
<span class="pc bpc" id="L691" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentList.PARAM_MTAS_LIST, false)) {</span>
<span class="nc" id="L692">					searchList.modifyRequest(rb, who, sreq);</span>
				}
<span class="pc bpc" id="L694" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentDocument.PARAM_MTAS_DOCUMENT, false)) {</span>
<span class="nc" id="L695">					searchDocument.modifyRequest(rb, who, sreq);</span>
				}
<span class="pc bpc" id="L697" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentKwic.PARAM_MTAS_KWIC, false)) {</span>
<span class="nc" id="L698">					searchKwic.modifyRequest(rb, who, sreq);</span>
				}
<span class="pc bpc" id="L700" title="1 of 2 branches missed.">				if (sreq.params.getBool(MtasSolrComponentPage.PARAM_MTAS_PAGE, false)) {</span>
<span class="nc" id="L701">          searchPage.modifyRequest(rb, who, sreq);</span>
        }
			}
<span class="nc" id="L704">		} catch (ExitableDirectoryReader.ExitingReaderException e) {</span>
<span class="nc" id="L705">			solrStatus.setError(e.getMessage());</span>
<span class="fc" id="L706">		}</span>
<span class="fc" id="L707">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see org.apache.solr.handler.component.SearchComponent#handleResponses(org.
	 * apache.solr.handler.component.ResponseBuilder,
	 * org.apache.solr.handler.component.ShardRequest)
	 */
	@Override
	public void handleResponses(ResponseBuilder rb, ShardRequest sreq) {
		 // System.out
		 // .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
		 // + &quot; - &quot; + rb.req.getParams().getBool(ShardParams.IS_SHARD, false)
		 // + &quot; HANDLERESPONSES &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc" id="L722">		MtasSolrStatus solrStatus = Objects</span>
<span class="fc" id="L723">				.requireNonNull((MtasSolrStatus) rb.req.getContext().get(MtasSolrStatus.class), &quot;couldn't find status&quot;);</span>
<span class="fc" id="L724">		solrStatus.setStage(rb.stage);</span>
		try {
<span class="fc bfc" id="L726" title="All 2 branches covered.">			if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>

				// do nothing
			}
<span class="nc" id="L730">		} catch (ExitableDirectoryReader.ExitingReaderException e) {</span>
<span class="nc" id="L731">			solrStatus.setError(e.getMessage());</span>
<span class="fc" id="L732">		}</span>
<span class="fc" id="L733">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * org.apache.solr.handler.component.SearchComponent#distributedProcess(org.
	 * apache.solr.handler.component.ResponseBuilder)
	 */
	@Override
	public void finishStage(ResponseBuilder rb) {
		 // System.out
		 // .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
		 //  + &quot; - &quot; + rb.req.getParams().getBool(ShardParams.IS_SHARD, false)
		 // + &quot; FINISHRESPONSES &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc" id="L748">		MtasSolrStatus solrStatus = Objects</span>
<span class="fc" id="L749">				.requireNonNull((MtasSolrStatus) rb.req.getContext().get(MtasSolrStatus.class), &quot;couldn't find status&quot;);</span>
<span class="fc" id="L750">		solrStatus.setStage(rb.stage);</span>
		try {
<span class="fc bfc" id="L752" title="All 2 branches covered.">			if (rb.stage == ResponseBuilder.STAGE_EXECUTE_QUERY) {</span>
<span class="fc" id="L753">				Status status = solrStatus.status();</span>
<span class="pc bpc" id="L754" title="1 of 2 branches missed.">				if (status.numberDocumentsFound == null) {</span>
<span class="fc" id="L755">					status.numberDocumentsFound = rb.getNumberDocumentsFound();</span>
				}
				// try to finish status from get fields stage
<span class="fc bfc" id="L758" title="All 2 branches covered.">			} else if (rb.stage &gt;= ResponseBuilder.STAGE_GET_FIELDS) {</span>
<span class="fc" id="L759">				finishStatus(solrStatus);</span>
			}
<span class="fc bfc" id="L761" title="All 2 branches covered.">			if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>
<span class="pc bpc" id="L762" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentVersion.PARAM_MTAS_VERSION, false)) {</span>
<span class="nc" id="L763">					searchVersion.finishStage(rb);</span>
				}
<span class="fc bfc" id="L765" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentStats.PARAM_MTAS_STATS, false)) {</span>
<span class="fc" id="L766">					searchStats.finishStage(rb);</span>
				}
<span class="fc bfc" id="L768" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L769">					searchTermvector.finishStage(rb);</span>
				}
<span class="fc bfc" id="L771" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentPrefix.PARAM_MTAS_PREFIX, false)) {</span>
<span class="fc" id="L772">					searchPrefix.finishStage(rb);</span>
				}
<span class="pc bpc" id="L774" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentFacet.PARAM_MTAS_FACET, false)) {</span>
<span class="nc" id="L775">					searchFacet.finishStage(rb);</span>
				}
<span class="fc bfc" id="L777" title="All 2 branches covered.">				if (rb.req.getParams().getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L778">					searchCollection.finishStage(rb);</span>
				}
<span class="pc bpc" id="L780" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentGroup.PARAM_MTAS_GROUP, false)) {</span>
<span class="nc" id="L781">					searchGroup.finishStage(rb);</span>
				}
<span class="pc bpc" id="L783" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentList.PARAM_MTAS_LIST, false)) {</span>
<span class="nc" id="L784">					searchList.finishStage(rb);</span>
				}
<span class="pc bpc" id="L786" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentDocument.PARAM_MTAS_DOCUMENT, false)) {</span>
<span class="nc" id="L787">					searchDocument.finishStage(rb);</span>
				}
<span class="pc bpc" id="L789" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentKwic.PARAM_MTAS_KWIC, false)) {</span>
<span class="nc" id="L790">					searchKwic.finishStage(rb);</span>
				}
<span class="pc bpc" id="L792" title="1 of 2 branches missed.">				if (rb.req.getParams().getBool(MtasSolrComponentPage.PARAM_MTAS_PAGE, false)) {</span>
<span class="nc" id="L793">          searchPage.finishStage(rb);</span>
        }
<span class="fc" id="L795">				mtasSolrResultMerge.merge(rb);</span>
			}
<span class="nc" id="L797">		} catch (ExitableDirectoryReader.ExitingReaderException e) {</span>
<span class="nc" id="L798">			solrStatus.setError(e.getMessage());</span>
<span class="fc" id="L799">		}</span>
<span class="fc" id="L800">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * org.apache.solr.handler.component.SearchComponent#distributedProcess(org.
	 * apache.solr.handler.component.ResponseBuilder)
	 */
	@Override
	public int distributedProcess(ResponseBuilder rb) throws IOException {
		 // System.out.println(System.nanoTime() + &quot; - &quot;
		 // + Thread.currentThread().getId() + &quot; - &quot;
		 // + rb.req.getParams().getBool(ShardParams.IS_SHARD, false)
		 // + &quot; DISTIRBUTEDPROCESS &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc" id="L815">		MtasSolrStatus solrStatus = Objects</span>
<span class="fc" id="L816">				.requireNonNull((MtasSolrStatus) rb.req.getContext().get(MtasSolrStatus.class), &quot;couldn't find status&quot;);</span>
<span class="fc" id="L817">		solrStatus.setStage(rb.stage);</span>
		try {
<span class="fc bfc" id="L819" title="All 2 branches covered.">			if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>
<span class="fc bfc" id="L820" title="All 6 branches covered.">				if (rb.stage == STAGE_TERMVECTOR_MISSING_TOP || rb.stage == STAGE_TERMVECTOR_MISSING_KEY</span>
						|| rb.stage == STAGE_TERMVECTOR_FINISH) {
<span class="fc" id="L822">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L823">					searchTermvector.distributedProcess(rb, mtasFields);</span>
<span class="pc bpc" id="L824" title="1 of 2 branches missed.">				} else if (rb.stage == STAGE_LIST) {</span>
<span class="nc" id="L825">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="nc" id="L826">					searchList.distributedProcess(rb, mtasFields);</span>
<span class="pc bfc" id="L827" title="All 2 branches covered.">				} else if (rb.stage == STAGE_PREFIX) {</span>
<span class="fc" id="L828">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L829">					searchPrefix.distributedProcess(rb, mtasFields);</span>
<span class="fc bfc" id="L830" title="All 2 branches covered.">				} else if (rb.stage == STAGE_STATS) {</span>
<span class="fc" id="L831">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L832">					searchStats.distributedProcess(rb, mtasFields);</span>
<span class="pc bpc" id="L833" title="1 of 2 branches missed.">				} else if (rb.stage == STAGE_FACET) {</span>
<span class="nc" id="L834">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="nc" id="L835">					searchFacet.distributedProcess(rb, mtasFields);</span>
<span class="pc bfc" id="L836" title="All 2 branches covered.">				} else if (rb.stage == STAGE_HEATMAP) {</span>
<span class="fc" id="L837">          ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L838">          searchHeatmap.distributedProcess(rb, mtasFields);</span>
<span class="fc bfc" id="L839" title="All 4 branches covered.">        } else if (rb.stage == STAGE_COLLECTION_INIT || rb.stage == STAGE_COLLECTION_FINISH) {</span>
<span class="fc" id="L840">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L841">					searchCollection.distributedProcess(rb, mtasFields);</span>
<span class="pc bpc" id="L842" title="1 of 2 branches missed.">				} else if (rb.stage == STAGE_GROUP) {</span>
<span class="nc" id="L843">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="nc" id="L844">					searchGroup.distributedProcess(rb, mtasFields);</span>
<span class="pc bpc" id="L845" title="1 of 2 branches missed.">				} else if (rb.stage == STAGE_DOCUMENT) {</span>
<span class="nc" id="L846">					ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="nc" id="L847">					searchDocument.distributedProcess(rb, mtasFields);</span>
				}
				// compute new stage and return if not finished
<span class="fc bfc" id="L850" title="All 4 branches covered.">				if (rb.stage &gt;= ResponseBuilder.STAGE_EXECUTE_QUERY &amp;&amp; rb.stage &lt; ResponseBuilder.STAGE_GET_FIELDS) {</span>
<span class="fc bfc" id="L851" title="All 2 branches covered.">					if (rb.stage &lt; STAGE_TERMVECTOR_MISSING_TOP</span>
<span class="fc bfc" id="L852" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L853">						return STAGE_TERMVECTOR_MISSING_TOP;</span>
<span class="fc bfc" id="L854" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_TERMVECTOR_MISSING_KEY</span>
<span class="fc bfc" id="L855" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L856">						return STAGE_TERMVECTOR_MISSING_KEY;</span>
<span class="fc bfc" id="L857" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_TERMVECTOR_FINISH</span>
<span class="fc bfc" id="L858" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L859">						return STAGE_TERMVECTOR_FINISH;</span>
<span class="fc bfc" id="L860" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_LIST</span>
<span class="pc bpc" id="L861" title="1 of 2 branches missed.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentList.PARAM_MTAS_LIST, false)) {</span>
<span class="nc" id="L862">						return STAGE_LIST;</span>
<span class="fc bfc" id="L863" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_PREFIX</span>
<span class="fc bfc" id="L864" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentPrefix.PARAM_MTAS_PREFIX, false)) {</span>
<span class="fc" id="L865">						return STAGE_PREFIX;</span>
<span class="fc bfc" id="L866" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_STATS</span>
<span class="fc bfc" id="L867" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentStats.PARAM_MTAS_STATS, false)) {</span>
<span class="fc" id="L868">						return STAGE_STATS;</span>
<span class="fc bfc" id="L869" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_FACET</span>
<span class="pc bpc" id="L870" title="1 of 2 branches missed.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentFacet.PARAM_MTAS_FACET, false)) {</span>
<span class="nc" id="L871">						return STAGE_FACET;</span>
<span class="fc bfc" id="L872" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_HEATMAP</span>
<span class="fc bfc" id="L873" title="All 2 branches covered.">              &amp;&amp; rb.req.getParams().getBool(MtasSolrComponentHeatmap.PARAM_MTAS_HEATMAP, false)) {</span>
<span class="fc" id="L874">            return STAGE_HEATMAP;</span>
<span class="fc bfc" id="L875" title="All 2 branches covered.">          } else if (rb.stage &lt; STAGE_GROUP</span>
<span class="pc bpc" id="L876" title="1 of 2 branches missed.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentGroup.PARAM_MTAS_GROUP, false)) {</span>
<span class="nc" id="L877">						return STAGE_GROUP;</span>
<span class="fc bfc" id="L878" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_COLLECTION_INIT</span>
<span class="fc bfc" id="L879" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L880">						return STAGE_COLLECTION_INIT;</span>
<span class="fc bfc" id="L881" title="All 2 branches covered.">					} else if (rb.stage &lt; STAGE_COLLECTION_FINISH</span>
<span class="fc bfc" id="L882" title="All 2 branches covered.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L883">						return STAGE_COLLECTION_FINISH;</span>
					}
<span class="pc bpc" id="L885" title="1 of 4 branches missed.">				} else if (rb.stage &gt;= ResponseBuilder.STAGE_GET_FIELDS &amp;&amp; rb.stage &lt; ResponseBuilder.STAGE_DONE) {</span>
<span class="pc bpc" id="L886" title="1 of 2 branches missed.">					if (rb.stage &lt; STAGE_DOCUMENT</span>
<span class="pc bpc" id="L887" title="1 of 2 branches missed.">							&amp;&amp; rb.req.getParams().getBool(MtasSolrComponentDocument.PARAM_MTAS_DOCUMENT, false)) {</span>
<span class="nc" id="L888">						return STAGE_DOCUMENT;</span>
					}
				}
			}
<span class="nc" id="L892">		} catch (ExitableDirectoryReader.ExitingReaderException e) {</span>
<span class="nc" id="L893">			solrStatus.setError(e.getMessage());</span>
<span class="nc" id="L894">			finishStatus(solrStatus);</span>
		} finally {
<span class="pc" id="L896">		  checkStatus(solrStatus);</span>
<span class="pc" id="L897">		}</span>
<span class="fc" id="L898">		return ResponseBuilder.STAGE_DONE;</span>
	}

	/**
	 * Gets the mtas fields.
	 *
	 * @param rb
	 *            the rb
	 * @return the mtas fields
	 */

	private ComponentFields getMtasFields(ResponseBuilder rb) {
<span class="fc" id="L910">		return (ComponentFields) rb.req.getContext().get(ComponentFields.class);</span>
	}

	/**
	 * Initialize request handler.
	 *
	 * @param rb
	 *            the rb
	 */
	private void initializeRequestHandler(ResponseBuilder rb) {
<span class="fc bfc" id="L920" title="All 2 branches covered.">		if (requestHandler == null) {</span>
			// try to initialize
<span class="pc bpc" id="L922" title="1 of 2 branches missed.">			for (Entry&lt;String, SolrInfoBean&gt; entry : rb.req.getCore().getInfoRegistry().entrySet()) {</span>
<span class="pc bpc" id="L923" title="1 of 2 branches missed.">				if (entry.getValue() instanceof MtasRequestHandler) {</span>
<span class="fc" id="L924">					requestHandlerName = entry.getKey();</span>
<span class="fc" id="L925">					requestHandler = (MtasRequestHandler) entry.getValue();</span>
<span class="fc" id="L926">					break;</span>
				}
<span class="nc" id="L928">			}</span>
		}
<span class="fc" id="L930">	}</span>

	/**
	 * Check status.
	 *
	 * @param status
	 *            the status
	 * @throws IOException
	 *             Signals that an I/O exception has occurred.
	 */
	private void checkStatus(MtasSolrStatus status) throws IOException {
<span class="pc bpc" id="L941" title="1 of 2 branches missed.">		if (!status.finished()) {</span>
<span class="pc bpc" id="L942" title="1 of 2 branches missed.">			if (status.error()) {</span>
<span class="nc" id="L943">				status.setFinished();</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">				if (requestHandler != null) {</span>
<span class="nc" id="L945">					requestHandler.finishStatus(status);</span>
				}
<span class="nc" id="L947">				throw new IOException(status.errorMessage());</span>
<span class="pc bpc" id="L948" title="1 of 2 branches missed.">			} else if (status.abort()) {</span>
<span class="nc" id="L949">				status.setFinished();</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">				if (requestHandler != null) {</span>
<span class="nc" id="L951">					requestHandler.finishStatus(status);</span>
				}
<span class="nc" id="L953">				throw new IOException(status.abortMessage());</span>
			}
		}
<span class="fc" id="L956">	}</span>

	/**
	 * Register status.
	 *
	 * @param solrStatus
	 *            the solr status
	 * @throws IOException
	 *             Signals that an I/O exception has occurred.
	 */
	private void registerStatus(MtasSolrStatus solrStatus) throws IOException {
<span class="pc bpc" id="L967" title="1 of 2 branches missed.">		if (requestHandler != null) {</span>
<span class="fc" id="L968">			Map&lt;String, ShardStatus&gt; shards = solrStatus.getShards();</span>
<span class="fc bfc" id="L969" title="All 2 branches covered.">			if (shards != null) {</span>
<span class="fc" id="L970">				Status status = solrStatus.status();</span>
<span class="fc" id="L971">				status.numberDocumentsTotal = Long.valueOf(0);</span>
<span class="fc" id="L972">				status.numberSegmentsTotal = 0;</span>
<span class="fc bfc" id="L973" title="All 2 branches covered.">				for (Entry&lt;String, ShardStatus&gt; entry : shards.entrySet()) {</span>
					// get shard info
<span class="fc" id="L975">					ShardInformation shardInformation = requestHandler.getShardInformation(entry.getKey());</span>
<span class="pc bpc" id="L976" title="1 of 2 branches missed.">					if (shardInformation == null) {</span>
<span class="nc" id="L977">						throw new IOException(&quot;no shard information &quot; + entry.getKey());</span>
					}
<span class="fc" id="L979">					ShardStatus shardStatus = entry.getValue();</span>
<span class="fc" id="L980">					shardStatus.name = shardInformation.name;</span>
<span class="fc" id="L981">					shardStatus.location = entry.getKey();</span>
<span class="fc" id="L982">					shardStatus.mtasHandler = shardInformation.mtasHandler;</span>
<span class="fc" id="L983">					shardStatus.numberDocumentsTotal = shardInformation.numberOfDocuments;</span>
<span class="fc" id="L984">					shardStatus.numberSegmentsTotal = shardInformation.numberOfSegments;</span>
<span class="fc" id="L985">					status.numberDocumentsTotal += shardInformation.numberOfDocuments;</span>
<span class="fc" id="L986">					status.numberSegmentsTotal += shardInformation.numberOfSegments;</span>
<span class="fc" id="L987">				}</span>
			}
<span class="fc" id="L989">			requestHandler.registerStatus(solrStatus);</span>
		}
<span class="fc" id="L991">	}</span>

	/**
	 * Error status.
	 *
	 * @param status
	 *            the status
	 * @param exception
	 *            the exception
	 */
	private void errorStatus(MtasSolrStatus status, IOException exception) {
		try {
<span class="nc" id="L1003">			status.setError(exception);</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">			if (requestHandler != null) {</span>
<span class="nc" id="L1005">				requestHandler.finishStatus(status);</span>
			}
<span class="nc" id="L1007">		} catch (IOException e) {</span>
<span class="nc" id="L1008">			log.error(e);</span>
<span class="nc" id="L1009">		}</span>
<span class="nc" id="L1010">	}</span>

	/**
	 * Finish status.
	 *
	 * @param status
	 *            the status
	 */
	private void finishStatus(MtasSolrStatus status) {
<span class="pc bpc" id="L1019" title="1 of 2 branches missed.">		if (!status.finished()) {</span>
<span class="fc" id="L1020">			status.setFinished();</span>
<span class="pc bpc" id="L1021" title="1 of 2 branches missed.">			if (requestHandler != null) {</span>
				try {
<span class="fc" id="L1023">					requestHandler.finishStatus(status);</span>
<span class="nc" id="L1024">				} catch (IOException e) {</span>
<span class="nc" id="L1025">					log.error(e);</span>
<span class="fc" id="L1026">				}</span>
			}
		}
<span class="fc" id="L1029">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>