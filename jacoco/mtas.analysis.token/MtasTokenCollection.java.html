<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MtasTokenCollection.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MTAS</a> &gt; <a href="index.source.html" class="el_package">mtas.analysis.token</a> &gt; <span class="el_source">MtasTokenCollection.java</span></div><h1>MtasTokenCollection.java</h1><pre class="source lang-java linenums">package mtas.analysis.token;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.Map.Entry;

import org.apache.lucene.analysis.payloads.PayloadHelper;
import org.apache.lucene.util.BytesRef;
import mtas.analysis.util.MtasParserException;

/**
 * The Class MtasTokenCollection.
 */
public class MtasTokenCollection {

  /** The token collection. */
<span class="fc" id="L22">  private HashMap&lt;Integer, MtasToken&gt; tokenCollection = new HashMap&lt;&gt;();</span>

  /** The token collection index. */
<span class="fc" id="L25">  private ArrayList&lt;Integer&gt; tokenCollectionIndex = new ArrayList&lt;&gt;();</span>

  /**
   * Instantiates a new mtas token collection.
   */
<span class="fc" id="L30">  public MtasTokenCollection() {</span>
<span class="fc" id="L31">    clear();</span>
<span class="fc" id="L32">  }</span>

  /**
   * Adds the.
   *
   * @param token the token
   * @return the integer
   */
  public Integer add(MtasToken token) {
<span class="fc" id="L41">    Integer id = token.getId();</span>
<span class="fc" id="L42">    tokenCollection.put(id, token);</span>
<span class="fc" id="L43">    return id;</span>
  }

  /**
   * Gets the.
   *
   * @param id the id
   * @return the mtas token
   */
  public MtasToken get(Integer id) {
<span class="fc" id="L53">    return tokenCollection.get(id);</span>
  }

  /**
   * Iterator.
   *
   * @return the iterator
   * @throws MtasParserException the mtas parser exception
   */
  public Iterator&lt;MtasToken&gt; iterator() throws MtasParserException {
<span class="fc" id="L63">    checkTokenCollectionIndex();</span>
<span class="fc" id="L64">    return new Iterator&lt;MtasToken&gt;() {</span>

<span class="fc" id="L66">      private Iterator&lt;Integer&gt; indexIterator = tokenCollectionIndex.iterator();</span>

      @Override
      public boolean hasNext() {
<span class="fc" id="L70">        return indexIterator.hasNext();</span>
      }

      @Override
      public MtasToken next() {
<span class="fc" id="L75">        return tokenCollection.get(indexIterator.next());</span>
      }

      @Override
      public void remove() {
<span class="nc" id="L80">        throw new UnsupportedOperationException();</span>
      }
    };
  }

  /**
   * Prints the.
   *
   * @throws MtasParserException the mtas parser exception
   */
  public void print() throws MtasParserException {
<span class="nc" id="L91">    Iterator&lt;MtasToken&gt; it = this.iterator();</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">    while (it.hasNext()) {</span>
<span class="nc" id="L93">      MtasToken token = it.next();</span>
<span class="nc" id="L94">      System.out.println(token);</span>
<span class="nc" id="L95">    }</span>
<span class="nc" id="L96">  }</span>

  /**
   * Gets the list.
   *
   * @return the list
   * @throws MtasParserException the mtas parser exception
   */
  public String[][] getList() throws MtasParserException {
<span class="nc" id="L105">    String[][] result = new String[(tokenCollection.size() + 1)][];</span>
<span class="nc" id="L106">    result[0] = new String[] { &quot;id&quot;, &quot;start real offset&quot;, &quot;end real offset&quot;,</span>
        &quot;provide real offset&quot;, &quot;start offset&quot;, &quot;end offset&quot;, &quot;provide offset&quot;,
        &quot;start position&quot;, &quot;end position&quot;, &quot;multiple positions&quot;, &quot;parent&quot;,
        &quot;provide parent&quot;, &quot;payload&quot;, &quot;prefix&quot;, &quot;postfix&quot; };
<span class="nc" id="L110">    int number = 1;</span>
<span class="nc" id="L111">    Iterator&lt;MtasToken&gt; it = this.iterator();</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">    while (it.hasNext()) {</span>
<span class="nc" id="L113">      MtasToken token = it.next();</span>
<span class="nc" id="L114">      String[] row = new String[15];</span>
<span class="nc" id="L115">      row[0] = token.getId().toString();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">      if (token.getRealOffsetStart() != null) {</span>
<span class="nc" id="L117">        row[1] = token.getRealOffsetStart().toString();</span>
<span class="nc" id="L118">        row[2] = token.getRealOffsetEnd().toString();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        row[3] = token.getProvideRealOffset() ? &quot;1&quot; : null;</span>
      }
<span class="nc bnc" id="L121" title="All 2 branches missed.">      if (token.getOffsetStart() != null) {</span>
<span class="nc" id="L122">        row[4] = token.getOffsetStart().toString();</span>
<span class="nc" id="L123">        row[5] = token.getOffsetEnd().toString();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        row[6] = token.getProvideOffset() ? &quot;1&quot; : null;</span>
      }
<span class="nc bnc" id="L126" title="All 2 branches missed.">      if (token.getPositionLength() != null) {</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (token.getPositionStart().equals(token.getPositionEnd())) {</span>
<span class="nc" id="L128">          row[7] = token.getPositionStart().toString();</span>
<span class="nc" id="L129">          row[8] = token.getPositionEnd().toString();</span>
<span class="nc" id="L130">          row[9] = null;</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        } else if ((token.getPositions() == null)</span>
<span class="nc" id="L132">            || (token.getPositions().length == (1 + token.getPositionEnd()</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                - token.getPositionStart()))) {</span>
<span class="nc" id="L134">          row[7] = token.getPositionStart().toString();</span>
<span class="nc" id="L135">          row[8] = token.getPositionEnd().toString();</span>
<span class="nc" id="L136">          row[9] = null;</span>
        } else {
<span class="nc" id="L138">          row[7] = null;</span>
<span class="nc" id="L139">          row[8] = null;</span>
<span class="nc" id="L140">          row[9] = Arrays.toString(token.getPositions());</span>
        }
      }
<span class="nc bnc" id="L143" title="All 2 branches missed.">      if (token.getParentId() != null) {</span>
<span class="nc" id="L144">        row[10] = token.getParentId().toString();</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        row[11] = token.getProvideParentId() ? &quot;1&quot; : null;</span>
      }
<span class="nc bnc" id="L147" title="All 2 branches missed.">      if (token.getPayload() != null) {</span>
<span class="nc" id="L148">        BytesRef payload = token.getPayload();</span>
<span class="nc" id="L149">        row[12] = Float.toString(PayloadHelper.decodeFloat(Arrays.copyOfRange(</span>
            payload.bytes, payload.offset, (payload.offset + payload.length))));
      }
<span class="nc" id="L152">      row[13] = token.getPrefix();</span>
<span class="nc" id="L153">      row[14] = token.getPostfix();</span>
<span class="nc" id="L154">      result[number] = row;</span>
<span class="nc" id="L155">      number++;</span>
<span class="nc" id="L156">    }</span>
<span class="nc" id="L157">    return result;</span>
  }

  /**
   * Check.
   *
   * @param autoRepair the auto repair
   * @param makeUnique the make unique
   * @throws MtasParserException the mtas parser exception
   */
  public void check(Boolean autoRepair, Boolean makeUnique)
      throws MtasParserException {
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">    if (autoRepair) {</span>
<span class="fc" id="L170">      autoRepair();</span>
    }
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">    if (makeUnique) {</span>
<span class="fc" id="L173">      makeUnique();</span>
    }
<span class="fc" id="L175">    checkTokenCollectionIndex();</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">    for (Integer i : tokenCollectionIndex) {</span>
      // minimal properties
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">      if (tokenCollection.get(i).getId() == null</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">          || tokenCollection.get(i).getPositionStart() == null</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">          || tokenCollection.get(i).getPositionEnd() == null</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">          || tokenCollection.get(i).getValue() == null) {</span>
<span class="nc" id="L182">        clear();</span>
<span class="nc" id="L183">        break;</span>
      }
<span class="fc" id="L185">    }</span>
<span class="fc" id="L186">  }</span>

  /**
   * Make unique.
   */
  private void makeUnique() {
<span class="fc" id="L192">    HashMap&lt;String, ArrayList&lt;MtasToken&gt;&gt; currentPositionTokens = new HashMap&lt;&gt;();</span>
    ArrayList&lt;MtasToken&gt; currentValueTokens;
<span class="fc" id="L194">    int currentStartPosition = -1;</span>
<span class="fc" id="L195">    MtasToken currentToken = null;</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">    for (Entry&lt;Integer, MtasToken&gt; entry : tokenCollection.entrySet()) {</span>
<span class="fc" id="L197">      currentToken = entry.getValue();</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">      if (currentToken.getPositionStart() &gt; currentStartPosition) {</span>
<span class="fc" id="L199">        currentPositionTokens.clear();</span>
<span class="fc" id="L200">        currentStartPosition = currentToken.getPositionStart();</span>
      } else {
<span class="fc bfc" id="L202" title="All 2 branches covered.">        if (currentPositionTokens.containsKey(currentToken.getValue())) {</span>
<span class="fc" id="L203">          currentValueTokens = currentPositionTokens</span>
<span class="fc" id="L204">              .get(currentToken.getValue());</span>

        } else {
<span class="fc" id="L207">          currentValueTokens = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L208">          currentPositionTokens.put(currentToken.getValue(),</span>
              currentValueTokens);
        }
<span class="fc" id="L211">        currentValueTokens.add(currentToken);</span>
      }
<span class="fc" id="L213">    }</span>
<span class="fc" id="L214">  }</span>

  /**
   * Auto repair.
   */
  private void autoRepair() {
<span class="fc" id="L220">    ArrayList&lt;Integer&gt; trash = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L221">    HashMap&lt;Integer, Integer&gt; translation = new HashMap&lt;&gt;();</span>
<span class="fc" id="L222">    HashMap&lt;Integer, MtasToken&gt; newTokenCollection = new HashMap&lt;&gt;();</span>
    Integer parentId;
<span class="fc" id="L224">    Integer maxId = null;</span>
<span class="fc" id="L225">    Integer minId = null;</span>
    Integer startOffset;
    Integer endOffset;
    MtasToken token;
    // check id, position and value
<span class="fc bfc" id="L230" title="All 2 branches covered.">    for (Entry&lt;Integer, MtasToken&gt; entry : tokenCollection.entrySet()) {</span>
<span class="fc" id="L231">      token = entry.getValue();</span>
      boolean putInTrash;
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">      putInTrash = token.getId() == null;</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">      putInTrash |= (token.getPositionStart() == null)</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">          || (token.getPositionEnd() == null);</span>
<span class="pc bpc" id="L236" title="2 of 4 branches missed.">      putInTrash |= token.getValue() == null || (token.getValue().isEmpty());</span>
<span class="pc bpc" id="L237" title="2 of 4 branches missed.">      putInTrash |= token.getPrefix() == null || (token.getPrefix().isEmpty());</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">      if (putInTrash) {</span>
<span class="nc" id="L239">        trash.add(entry.getKey());</span>
      }
<span class="fc" id="L241">    }</span>
    // check parentId and offset
<span class="fc bfc" id="L243" title="All 2 branches covered.">    for (Entry&lt;Integer, MtasToken&gt; entry : tokenCollection.entrySet()) {</span>
<span class="fc" id="L244">      token = entry.getValue();</span>
<span class="fc" id="L245">      parentId = token.getParentId();</span>
<span class="pc bpc" id="L246" title="1 of 4 branches missed.">      if (parentId != null &amp;&amp; (!tokenCollection.containsKey(parentId)</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">          || trash.contains(parentId))) {</span>
<span class="nc" id="L248">        token.setParentId(null);</span>
      }
<span class="fc" id="L250">    }</span>
    // empty bin
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">    if (!trash.isEmpty()) {</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">      for (Integer i : trash) {</span>
<span class="nc" id="L254">        tokenCollection.remove(i);</span>
<span class="nc" id="L255">      }</span>
    }
    // always check ids
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">    if (tokenCollection.size() &gt; 0) {</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">      for (Integer i : tokenCollection.keySet()) {</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">        maxId = ((maxId == null) ? i : Math.max(maxId, i));</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">        minId = ((minId == null) ? i : Math.min(minId, i));</span>
<span class="fc" id="L262">      }</span>
      // check
<span class="pc bpc" id="L264" title="2 of 4 branches missed.">      if ((minId &gt; 0) || ((1 + maxId - minId) != tokenCollection.size())) {</span>
<span class="nc" id="L265">        int newId = 0;</span>
        // create translation
<span class="nc bnc" id="L267" title="All 2 branches missed.">        for (Integer i : tokenCollection.keySet()) {</span>
<span class="nc" id="L268">          translation.put(i, newId);</span>
<span class="nc" id="L269">          newId++;</span>
<span class="nc" id="L270">        }</span>
        // translate objects
<span class="nc bnc" id="L272" title="All 2 branches missed.">        for (Entry&lt;Integer, MtasToken&gt; entry : tokenCollection.entrySet()) {</span>
<span class="nc" id="L273">          token = entry.getValue();</span>
<span class="nc" id="L274">          parentId = token.getParentId();</span>
<span class="nc" id="L275">          token.setId(translation.get(entry.getKey()));</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">          if (parentId != null) {</span>
<span class="nc" id="L277">            token.setParentId(translation.get(parentId));</span>
          }
<span class="nc" id="L279">        }</span>
        // new tokenCollection
<span class="nc" id="L281">        Iterator&lt;Map.Entry&lt;Integer, MtasToken&gt;&gt; iter = tokenCollection</span>
<span class="nc" id="L282">            .entrySet().iterator();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        while (iter.hasNext()) {</span>
<span class="nc" id="L284">          Map.Entry&lt;Integer, MtasToken&gt; entry = iter.next();</span>
<span class="nc" id="L285">          newTokenCollection.put(translation.get(entry.getKey()),</span>
<span class="nc" id="L286">              entry.getValue());</span>
<span class="nc" id="L287">          iter.remove();</span>
<span class="nc" id="L288">        }</span>
<span class="nc" id="L289">        tokenCollection = newTokenCollection;</span>
      }
    }
<span class="fc" id="L292">  }</span>

  /**
   * Check token collection index.
   *
   * @throws MtasParserException the mtas parser exception
   */
  private void checkTokenCollectionIndex() throws MtasParserException {
<span class="fc bfc" id="L300" title="All 2 branches covered.">    if (tokenCollectionIndex.size() != tokenCollection.size()) {</span>
      MtasToken token;
<span class="fc" id="L302">      Integer maxId = null;</span>
<span class="fc" id="L303">      Integer minId = null;</span>
<span class="fc" id="L304">      tokenCollectionIndex.clear();</span>
<span class="fc bfc" id="L305" title="All 2 branches covered.">      for (Entry&lt;Integer, MtasToken&gt; entry : tokenCollection.entrySet()) {</span>
<span class="fc" id="L306">        token = entry.getValue();</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">        maxId = ((maxId == null) ? entry.getKey()</span>
<span class="fc" id="L308">            : Math.max(maxId, entry.getKey()));</span>
<span class="fc bfc" id="L309" title="All 2 branches covered.">        minId = ((minId == null) ? entry.getKey()</span>
<span class="fc" id="L310">            : Math.min(minId, entry.getKey()));</span>
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">        if (token.getId() == null) {</span>
<span class="nc" id="L312">          throw new MtasParserException(</span>
<span class="nc" id="L313">              &quot;no id for token (&quot; + token.getValue() + &quot;)&quot;);</span>
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">        } else if ((token.getPositionStart() == null)</span>
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">            || (token.getPositionEnd() == null)) {</span>
<span class="nc" id="L316">          throw new MtasParserException(&quot;no position for token with id &quot;</span>
<span class="nc" id="L317">              + token.getId() + &quot; (&quot; + token.getValue() + &quot;)&quot;);</span>
<span class="pc bpc" id="L318" title="2 of 4 branches missed.">        } else if (token.getValue() == null || (token.getValue().equals(&quot;&quot;))) {</span>
<span class="nc" id="L319">          throw new MtasParserException(</span>
<span class="nc" id="L320">              &quot;no value for token with id &quot; + token.getId());</span>
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">        } else if (token.getPrefix() == null</span>
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">            || (token.getPrefix().equals(&quot;&quot;))) {</span>
<span class="nc" id="L323">          throw new MtasParserException(</span>
<span class="nc" id="L324">              &quot;no prefix for token with id &quot; + token.getId());</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">        } else if ((token.getParentId() != null)</span>
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">            &amp;&amp; !tokenCollection.containsKey(token.getParentId())) {</span>
<span class="nc" id="L327">          throw new MtasParserException(</span>
<span class="nc" id="L328">              &quot;missing parentId for token with id &quot; + token.getId());</span>
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">        } else if ((token.getOffsetStart() == null)</span>
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">            || (token.getOffsetEnd() == null)) {</span>
<span class="nc" id="L331">          throw new MtasParserException(&quot;missing offset for token with id &quot;</span>
<span class="nc" id="L332">              + token.getId() + &quot; (&quot; + token.getValue() + &quot;)&quot;);</span>
        }
<span class="fc" id="L334">        tokenCollectionIndex.add(entry.getKey());</span>
<span class="fc" id="L335">      }</span>
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">      if ((tokenCollection.size() &gt; 0)</span>
<span class="pc bpc" id="L337" title="2 of 4 branches missed.">          &amp;&amp; ((minId &gt; 0) || ((1 + maxId - minId) != tokenCollection.size()))) {</span>
<span class="nc" id="L338">        throw new MtasParserException(&quot;missing ids&quot;);</span>
      }
<span class="fc" id="L340">      Collections.sort(tokenCollectionIndex, getCompByName());</span>
    }
<span class="fc" id="L342">  }</span>

  /**
   * Gets the comp by name.
   *
   * @return the comp by name
   */
  public Comparator&lt;Integer&gt; getCompByName() {
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">    return new Comparator&lt;Integer&gt;() {</span>
      @Override
      public int compare(Integer t1, Integer t2) {
<span class="fc" id="L353">        Integer p1 = tokenCollection.get(t1).getPositionStart();</span>
<span class="fc" id="L354">        Integer p2 = tokenCollection.get(t2).getPositionStart();</span>
<span class="pc bpc" id="L355" title="2 of 4 branches missed.">        assert p1 != null : &quot;no position for &quot; + tokenCollection.get(t1);</span>
<span class="pc bpc" id="L356" title="2 of 4 branches missed.">        assert p2 != null : &quot;no position for &quot; + tokenCollection.get(t2);</span>
<span class="fc bfc" id="L357" title="All 2 branches covered.">        if (p1.equals(p2)) {</span>
<span class="fc" id="L358">          Integer o1 = tokenCollection.get(t1).getOffsetStart();</span>
<span class="fc" id="L359">          Integer o2 = tokenCollection.get(t2).getOffsetStart();</span>
<span class="pc bpc" id="L360" title="2 of 4 branches missed.">          if (o1 != null &amp;&amp; o2 != null) {</span>
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">            if (o1.equals(o2)) {</span>
<span class="fc" id="L362">              return tokenCollection.get(t1).getValue()</span>
<span class="fc" id="L363">                  .compareTo(tokenCollection.get(t2).getValue());</span>
            } else {
<span class="nc" id="L365">              return o1.compareTo(o2);</span>
            }
          } else {
<span class="nc" id="L368">            return tokenCollection.get(t1).getValue()</span>
<span class="nc" id="L369">                .compareTo(tokenCollection.get(t2).getValue());</span>
          }
        }
<span class="fc" id="L372">        return p1.compareTo(p2);</span>
      }
    };
  }

  /**
   * Clear.
   */
  private void clear() {
<span class="fc" id="L381">    tokenCollectionIndex.clear();</span>
<span class="fc" id="L382">    tokenCollection.clear();</span>
<span class="fc" id="L383">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>